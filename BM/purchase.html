<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>亦知亦行-报名系统</title>
    <link rel="stylesheet" href="../assets/node_modules/normalize.css/normalize.css">
    <link rel="stylesheet" href="../assets/vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/bm.main.css">
    <link rel="ICON" href="../assets/img/main/icon.png">
</head>
<body class="bm-body">
<header>
    <div class="logo-box">
        <img src="../assets/img/logo.svg" alt="">
    </div>
</header>
<div class="bm-content" id="purchase_page">
    <div class="container bm-container bm-purchase-container">
        <h2>支付学费</h2>
        <div class="bm-text-box">
            <p class="bm-text">学生优惠价：<span>￥7990</span></p>
        </div>
        <div class="bm-text-box">
            <span class="bm-text">选择支付方式：</span>
        </div>
        <div class="bm-tag-box" v-bind:class = "{'active': tagCheck==1}">
            <p class="bm-tag" @click="bmTagCheck(1)"><img src="../assets/img/icon/bm_wechat.svg" alt="">微信支付<i class="fa fa-check"></i></p>
        </div>
        <div class="bm-tag-box" v-bind:class = "{'active': tagCheck==2}">
            <p class="bm-tag" @click="bmTagCheck(2)"><img src="../assets/img/icon/bm_alipay.svg" alt="">支付宝支付<i class="fa fa-check"></i></p>
        </div>
        <div class="bm-btn-box">
            <a href="javascript:;" class="bm-btn" @click="purchaseNow()">确认支付</a>
        </div>
    </div>
</div>
<script src="../assets/js/jweixin-1.0.0.js"></script>
<script src="../assets/node_modules/vue/dist/vue.min.js"></script>
<script src="../assets/node_modules/axios/dist/axios.min.js"></script>
<script>
    wx.config({
        debug: true,
        appId: 'wx80e422538e992cf8',
        jsApiList: ['chooseWXPay']
    });

    var mainVue = new Vue({
        el:'#purchase_page',
        data:{
            tagCheck: 0,
            openid: 0
        },
        methods: {
            bmTagCheck: function (num) {
                if (mainVue.tagCheck === num){
                    mainVue.tagCheck = 0;
                } else {
                    mainVue.tagCheck = num;
                }
            },
            purchaseNow: function () {
                if (mainVue.tagCheck === 1){
                    var jsonStr = {
                        openid: '',
                    };
                    jsonStr.openid = this.openid;
                    axios.post("http://www.cogitoactio.com/api/v1/wechat/purchase",{
                        data: jsonStr
                    }).then(function (res) {
                        console.log(res);
                        wx.chooseWXPay({
                            timestamp: res.data.timeStamp,
                            appId: res.data.appId,
                            nonceStr: res.data.nonceStr,
                            package: res.data.package,
                            signType: res.data.signType, // 注意：新版支付接口使用 MD5 加密
                            paySign: res.data.sign,
                            success: function(res) {
                                // 支付成功后的回调函数
                                if (res.errMsg === "chooseWXPay:ok") {
                                    window.location.href = 'purchaseSuccess.html'
                                } else {
                                    alert(res.errMsg);
                                }
                            },
                            cancel: function(res) {
                                //支付取消
                                alert('支付取消');
                            }
                        });
                    }).catch(function (error) {
                        console.log(error);
                    });
                }else if (mainVue.tagCheck === 2){
                    window.location.href = 'bmAlipay.html';
                }else{
                    alert('请选择支付方式');
                }
            }
        },
        mounted: function () {
            this.openid = decodeURI(window.location.search.replace('?openid=',''));
            console.log(this.openid)
        }
    })
</script>
</body>
</html>