<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>亦知亦行 知行谈判助手</title>
    <link rel="stylesheet" href="../../assets/node_modules/normalize.css/normalize.css">
    <link rel="stylesheet" href="../../assets/node_modules/animate.css/animate.css">
    <link rel="stylesheet" href="../../assets/css/qdv1.0.main.css">
    <link rel="ICON" href="../../assets/img/main/icon.png">
    <style>
        .positionStatic {
            position: static !important;
            margin-top: 60px !important;
        }

        .weightOverproof span {
            color: #EB5548;
            font-size: 16px;
        }

        .qd-close-new-btn {
            background-size: 15px 15px;
        }
    </style>
</head>
<body>
<div class="qd-content" id="qd_issues_page" v-cloak>
    <div class="qd-header-box">
        <div class="qd-page-title-box">
            <a v-bind:href="'menu.html?qdId='+qdId" class="qd-close-new-btn"></a>
            <h3 class="qd-page-title">{{qdData.title}}</h3>
        </div>
    </div>

    <!-- 2 -->
    <div class="qd-section" style="margin-top: 3px">
        <div class="qd-issues-list-content">
            <div class="qd-module-btn-box clear" v-for="(data,index) in issuesBothData">
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-5" @click="openBothModal(index)"
                       href="javascript:;" v-show="data.name!==''"></a>
                </div>
                <div class="qd-module-btn">
                    <div class="qd-input-box qd-input-box__1">
                        <input v-model="data.name" @change="reAlterBoth(index)" type="text" name="issuesName"
                               class="qd-input"
                               placeholder="议题名称">
                    </div>
                </div>
                <div class="qd-module-btn">
                    <div class="qd-input-box qd-input-box__1">
                        <input v-model="data.weight" @change="reAlterBoth(index)" type="number" name="issuesWeight" min="1"
                               max="100"
                               class="qd-input" placeholder="议题权重">
                    </div>
                </div>
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-3"
                       v-show="!isAdd && index!== 0 && data.name!==''"
                       @click="btnPriorityBoth(1,index)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-3"
                       v-show="isAdd && data.number!==1 && data.name!=='' && index!==issuesBothData.length-1"
                       @click="btnPriorityBoth(1,index)" href="javascript:;"></a>

                    <a class="qd-module-small-btn qd-module-small-btn-4"
                       v-show="!isAdd&&index !== issuesBothData.length-1&&data.name!==''"
                       @click="btnPriorityBoth(2,index)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-4"
                       v-show="isAdd && index!==issuesBothData.length-2 && index!==issuesBothData.length-1 && data.name!==''"
                       @click="btnPriorityBoth(2,index)" href="javascript:;"></a>
                </div>
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-2" @click="delIssuesBoth(index)"
                       href="javascript:;"></a>
                </div>
            </div>

            <div class="qd-module-btn-box qd-module-add-btn-box clear">
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;"></a>
                <a href="javascript:;" class="qd-module-btn" v-show="isAdd||isFull" style="font-size:16px;width: 30%"></a>
                <a href="javascript:;" class="qd-module-btn" v-show="!isAdd&&!isFull" @click="addIssuesBothModal()"
                   style="font-size:20px;width: 30%">+</a>
                <a href="javascript:;" class="qd-module-btn"
                   style="font-size:12px;width: 30%">总权重：&nbsp;{{allWeight}}</a>
                <a href="javascript:;" class="qd-module-btn" style="width: 30%;display: none"></a>
                <a href="javascript:;" class="qd-module-btn" style="font-size:12px;width: 30%;color:#5f95ed"
                   @click="showBothPossible()" v-show="isWriteFull">显示所有可能</a>
            </div>
        </div>
        <div class="qd-modal-box" v-show="showModal">
            <div class="qd-modal-header">
                <span @click="closeBothModal()" class="qd-modal-close-btn"></span>
            </div>
            <div class="qd-modal-content">
                <div class="qd-new-issues-box">
                    <div class="qd-new-issues-header">
                        <p>议题：{{modalData.name}}</p>
                    </div>
                    <div class="qd-new-issues-content">
                        <div class="qd-new-issues-details-box">
                            <p class="qd-new-issues-details">
                                渴望（您最理想的渴望结果）
                                <input type="text" v-model="modalData.content[0].content" @change="changeIssuesBothContent(1)"
                                       class="qd-new-issues-details-input" placeholder="请输入您最理想的的渴望结果"/>&nbsp;&nbsp;,
                                <span class="qd-new-issues-details-grade"
                                      v-show="writeIndex >= 2 || modalData.content[0].content!==''">这个结果对您来说有多重要（0不重要-10很重要）
                                <input type="text" v-model="modalData.content[0].grade"
                                       class="qd-new-issues-details-input" @change="changeIssuesBothContent(2)"/>&nbsp;&nbsp;。
                            </span>
                            </p>
                            <!--<div class="">-->
                            <!--<a href="javascript:;" @class="qd-add-new-issues-details" @click="addIssuesDetails">添加其他选项 </a><span>取消</span>-->
                            <!--<p class="qd-new-issues-details"-->
                            <!--v-show="writeIndex >= 3 || modalData.content[0].content!==''">-->
                            <!--底线是-->
                            <!--<input type="text" v-model="modalData.content[1].content" @change="changeIssuesBothContent(3)"-->
                            <!--class="qd-new-issues-details-input" placeholder="底线是对您最坏的条件下，您所能承受的结果"/>&nbsp;&nbsp;,-->
                            <!--<span class="qd-new-issues-details-grade"-->
                            <!--v-show="writeIndex >= 4 || modalData.content[1].content!==''">这个结果对您来说有多重要（0不重要-10很重要）-->
                            <!--<input type="text" v-model="modalData.content[1].grade" @change="changeIssuesBothContent(4)"-->
                            <!--class="qd-new-issues-details-input"/>&nbsp;&nbsp;。-->
                            <!--</span>-->
                            <!--</p>-->
                            <!--</div>-->
                            <p class="qd-new-issues-details"
                               v-show="writeIndex >= 3 || modalData.content[0].grade!==''">
                                底线（您能接受的最坏结果）
                                <input type="text" v-model="modalData.content[1].content" @change="changeIssuesBothContent(3)"
                                       class="qd-new-issues-details-input" placeholder="请输入您能接受的最坏结果"/>&nbsp;&nbsp;,
                                <span class="qd-new-issues-details-grade"
                                      v-show="writeIndex >= 4 || modalData.content[1].content!==''">这个结果对您来说有多重要（0不重要-10很重要）
                                <input type="text" v-model="modalData.content[1].grade" @change="changeIssuesBothContent(4)"
                                       class="qd-new-issues-details-input"/>&nbsp;&nbsp;。
                            </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="qd-modal-box" style="position: absolute" v-show="showPossibleModal">
            <div class="qd-modal-header">
                <span @click="showPossibleModal = false" class="qd-modal-close-btn"></span>
            </div>
            <div class="qd-modal-content">
                <div class="qd-module-issuesPossibleData-box">
                    <h3>所有可能</h3>
                    <div class="qd-module-issuesPossibleData-content clear">
                        <div class="qd-module-issuesPossibleData-content-1">
                            序号
                        </div>
                        <div class="qd-module-issuesPossibleData-content-1 clear">
                            内容
                        </div>
                        <div class="qd-module-issuesPossibleData-content-1">
                            评分
                        </div>
                    </div>
                    <div class="qd-module-issuesPossibleData-content clear" v-for="(data,index) in issuesPossibleData">
                        <div class="qd-module-issuesPossibleData-content-1">
                            事例{{index+1}}
                        </div>
                        <div class="qd-module-issuesPossibleData-content-1 clear">
                            <div class="qd-module-issuesPossibleData-content-child">
                                <div class="qd-module-issuesPossibleData-content-child-content" v-for="data1 in issuesBothData">
                                    {{data1.name}}
                                </div>
                            </div>
                            <div class="qd-module-issuesPossibleData-content-child">
                                <div class="qd-module-issuesPossibleData-content-child-content" v-for="data2 in data">
                                    {{data2.content}}
                                </div>
                            </div>
                        </div>
                        <div class="qd-module-issuesPossibleData-content-1">
                            {{data | totalPoints}}
                        </div>
                    </div>
                </div>
                <!--<div class="qd-module-btn-box clear" v-for="issuesPossibleData">
                </div>-->
            </div>
        </div>
    </div>

</div>
<script type="text/javascript" src="https://cdn.bootcss.com/vue/2.5.17-beta.0/vue.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
<script type="text/javascript">
    'user strict';
    var mainVue = new Vue({
        el: '#qd_issues_page',
        data: {
            issuesPage: 1,
            isCheck: false,
            showModal: false,
            showPossibleModal: false,
            modalNum: 1,
            issuesBothData: [],
            issuesBothData: [],
            isWriteFull:false,
            issuesPossibleData: [],
            qdId: '',
            userId: '',
            isAlter: 0,
            isFull: false,
            beforeData: {
                name: '',
                weight: ''
            },
            writeIndex: 1,
            modalData: {
                number: 0,
                name: '',
                weight: 0,
                content: [{
                    content: '',
                    grade: '',
                }, {
                    content: '',
                    grade: '',
                }]
            },
            qdData: [],
            modalIndex: 0,
            isAdd: false,

        },
        computed: {
            allWeight: function () {
                var allWeight = 0
                for (var i in this.issuesBothData) {
                    allWeight = allWeight + Number(this.issuesBothData[i].weight)
                }
                return allWeight + '%';
            },
        },
        filters: {
            totalPoints: function (val) {
                var totalPoints = 0
                for (var i = 0; i < val.length; i++) {
                    console.log(val[i].grade + '*' + mainVue.issuesBothData[i].weight + '/ 100' + '=' + Number(val[i].grade * mainVue.issuesBothData[i].weight / 100))
                    totalPoints = Number(totalPoints) + Number(val[i].grade * mainVue.issuesBothData[i].weight / 100);
                }
                return totalPoints.toFixed(2);
            }
        },
        methods: {
            openBothModal: function (index) {
                this.modalIndex = index;
                this.writeIndex = 1;
                this.modalData = JSON.parse(JSON.stringify(this.issuesBothData[index]));
                this.showModal = true;
            },

            closeBothModal: function () {
                this.showModal = false;
                this.modalData = {
                    number: 0,
                    name: '',
                    weight: 0,
                    content: [{
                        content: '',
                        grade: '',
                        both1: ''
                    }, {
                        content: '',
                        grade: '',
                        both1: '',
                    }]
                }
            },

            showBothPossible: function () {
                this.showPossibleModal = true;

                function doCombination(arr) {
                    console.log(arr)
                    var count = arr.length - 1; //数组长度(从0开始)
                    var tmp = [];
                    var totalArr = [];// 总数组

                    return doCombinationCallback(arr, 0);//从第一个开始
                    //js 没有静态数据，为了避免和外部数据混淆，需要使用闭包的形式
                    function doCombinationCallback(arr, curr_index) {
                        for (val of arr[curr_index]) {
                            tmp[curr_index] = val;//以curr_index为索引，加入数组
                            //当前循环下标小于数组总长度，则需要继续调用方法
                            console.log('a-'+val)
                            if (curr_index < count) {
                                doCombinationCallback(arr, curr_index + 1);//继续调用
                            } else {
                                totalArr.push(tmp);//(直接给push进去，push进去的不是值，而是值的地址)
                            }

                            //js  对象都是 地址引用(引用关系)，每次都需要重新初始化，否则 totalArr的数据都会是最后一次的 tmp 数据；
                            oldTmp = tmp;
                            tmp = [];
                            for (index of oldTmp) {
                                tmp.push(index);
                            }
                            console.log(tmp)
                        }
                        return totalArr;
                    }
                }

                var b = []
                for (var i = 0; i < this.issuesBothData.length; i++) {
                    b[i] = [];
                    for (var j = 0; j < this.issuesBothData[i].content.length; j++) {
                        b[i][j] = this.issuesBothData[i].content[j];
                    }
                }
                this.issuesPossibleData = doCombination(b);
            },

            addIssuesBothModal: function () {
                mainVue.isAdd = true;
                this.issuesBothData.push(this.modalData);
                this.issuesBothData[this.issuesBothData.length - 1].number = this.issuesBothData.length;
                this.averageWeight();
                this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                mainVue.updatedIssuesBoth();
            },

            averageWeight: function () {
                var averageWeight = parseInt(100 / this.issuesBothData.length);
                for (var i = 0; i < this.issuesBothData.length; i++) {
                    this.issuesBothData[i].weight = averageWeight
                }
                if(averageWeight * this.issuesBothData.length != 100){
                    this.issuesBothData[0].weight = 100 - averageWeight * (this.issuesBothData.length - 1);
                }
            },

            assignWeight: function (val) {
                var assignWeight = parseInt(this.issuesBothData[val].weight / (this.issuesBothData.length - 1));
                this.issuesBothData.splice(val, 1);
                for (var i = 0; i < this.issuesBothData.length; i++) {
                    this.issuesBothData[i].weight = Number(this.issuesBothData[i].weight) + Number(assignWeight)
                }
            },

            /*
            * delIssuesBoth() 删除议题
            * index: 删除议题的索引
            * */
            delIssuesBoth: function (index) {
                var res = confirm("确定删除此议题？");
                if (res) {
                    this.assignWeight(index);
                    this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                    mainVue.updatedIssuesBoth(2);
                } else {

                }
            },

            btnPriorityBoth: function (val, index) {
                var t1 = 0;
                var t2 = 0;
                if (val === 1) {
                    t1 = Number(this.issuesBothData[index].weight);
                    t2 = Number(this.issuesBothData[index - 1].weight);
                    this.issuesBothData[index] = JSON.parse(JSON.stringify(this.qdData.issuesBoth[index - 1]));
                    this.issuesBothData[index].number = index + 1;
                    this.issuesBothData[index].weight = t1;
                    this.issuesBothData[index - 1] = JSON.parse(JSON.stringify(this.qdData.issuesBoth[index]));
                    this.issuesBothData[index - 1].number = index;
                    this.issuesBothData[index - 1].weight = t2;
                    this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                    mainVue.updatedIssuesBoth();
                } else if (val === 2) {
                    t1 = Number(this.issuesBothData[index].weight);
                    t2 = Number(this.issuesBothData[index + 1].weight);
                    this.issuesBothData[index] = JSON.parse(JSON.stringify(this.qdData.issuesBoth[index + 1]));
                    this.issuesBothData[index].number = index + 1;
                    this.issuesBothData[index].weight = t1;
                    this.issuesBothData[index + 1] = JSON.parse(JSON.stringify(this.qdData.issuesBoth[index]));
                    this.issuesBothData[index + 1].number = index + 2;
                    this.issuesBothData[index + 1].weight = t2;
                    this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                    mainVue.updatedIssuesBoth();
                }

            },

            reAlterBoth: function (index) {
                if (this.issuesBothData[index].name === '') {
                    alert('请输入议题名称');
                } else if (this.issuesBothData[index].weight === '') {
                    alert('请输入此议题权重');
                    this.issuesBothData[index].weight = 0
                } else {
                    if (this.allWeight > 100) {
                        alert('总权重大于100，请重新分配！！！');
                        this.issuesBothData[index].weight = 0
                    } else {
                        var repetition = false;
                        for (var i in this.issuesBothData) {
                            if (index == i) {

                            } else {
                                if (this.issuesBothData[index].name === this.issuesBothData[i].name) {
                                    repetition = true;
                                    break;
                                }
                            }
                        }
                        console.log(repetition)
                        if (repetition) {
                            alert('议题名称重复');
                            if (this.isAdd) {
                                this.issuesBothData[index].name = ''
                            } else {
                                this.issuesBothData[index].name = String(this.qdData.issuesBoth[index].name);
                            }
                        } else {
                            function sortId(a, b) {
                                return Number(a.weight) < Number(b.weight);
                            }

                            this.issuesBothData.sort(sortId);
                            this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                            mainVue.updatedIssuesBoth();
                        }
                    }
                }
            },

            changeIssuesBothContent: function (index) {
                this.writeIndex = index + 1;
                if (index === 4) {
                    console.log(this.modalData.content[1].grade >= this.modalData.content[0].grade)
                    if (Number(this.modalData.content[1].grade) >= Number(this.modalData.content[0].grade)) {
                        alert("底线评分不能超过渴望评分！")
                    } else {
                        this.issuesBothData[mainVue.modalIndex].content = JSON.parse(JSON.stringify(this.modalData.content));
                        this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                        mainVue.updatedIssuesBoth();
                    }
                } else {
                    this.issuesBothData[mainVue.modalIndex].content = JSON.parse(JSON.stringify(this.modalData.content));
                    this.qdData.issuesBoth = JSON.parse(JSON.stringify(this.issuesBothData));
                    mainVue.updatedIssuesBoth();
                }
            },

            updatedIssuesBoth: function (val) {
                var jsonStr = {
                    userId: '',
                    docId: '',
                    data: '',
                }
                jsonStr.userId = this.userId;
                jsonStr.docId = this.qdId;
                jsonStr.data = this.qdData;
                axios.post("http://www.cogitoactio.com/api/v1/negotiation/updateNegotiation ", jsonStr).then(function (res) {
                    if (res.data.data) {
                        if (val === 2) {
                            alert('删除成功')
                        }
                        if (mainVue.issuesBothData.length > 0) {
                            mainVue.isAdd = mainVue.issuesBothData[mainVue.issuesBothData.length - 1].name === '';
                        } else if (mainVue.issuesBothData.length >= 0) {
                            mainVue.isFull = true;
                        } else {
                            mainVue.isAdd = false;
                        }
                        mainVue.issuesBothData = JSON.parse(JSON.stringify(mainVue.qdData.issuesBoth));

                        var isWriteFull = true;
                        for (var i = 0; i < mainVue.issuesBothData.length; i++) {
                            for (var j = 0; j < mainVue.issuesBothData[i].content.length; j++) {
                                if(mainVue.issuesBothData[i].content[j].content==='' || mainVue.issuesBothData[i].content[j].grade===''){
                                    isWriteFull = false;
                                    break;
                                }
                            }
                        }
                        mainVue.isWriteFull = isWriteFull
                    } else {
                        alert('请求失败')
                    }
                }).catch(function (error) {
                    console.log(error);
                })
            }
        },

        mounted: function () {
            var userId = localStorage.getItem('userId');
            this.userId = userId;
            if (userId === null) {
                window.location.href = '../home.html'
            }

            function GetRequest() {
                var url = decodeURI(location.search);
                var theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    var str = url.substr(1);
                    strs = str.split("&");
                    for (var i = 0; i < strs.length; i++) {
                        theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                    }
                }
                return theRequest;
            }

            var urlData = GetRequest();
            if (urlData.qdId === undefined) {
                window.location.href = '../home.html'
            } else {
                this.qdId = urlData.qdId;
                var jsonStr = {
                    userId: '',
                    docId: ''
                }
                jsonStr.userId = this.userId;
                jsonStr.docId = this.qdId;
                if (jsonStr.docId === 'qdCogiactio1') {
                    this.issuesBothData = [
                        {
                            number: 0,
                            name: '价格',
                            weight: 100,
                            content: [{
                                content: '88M',
                                grade: '10',
                                both1: ''
                            }, {
                                content: '44M',
                                grade: '3',
                                both1: '',
                            }]
                        }
                    ];
                    this.qdData = {
                        both1: '珍珠投资公司', //己方
                        both2: '地产一号', //对方
                        title: '汉密尔顿地产', //项目名称
                        issues: [
                            {
                                number: 0,
                                name: '价格',
                                weight: 30,
                                content: [{
                                    content: '',
                                    grade: '10',
                                    both1: ''
                                }, {
                                    content: '',
                                    grade: '',
                                    both1: '',
                                }]
                            }
                        ],
                        background: [],  //背景篇
                        tactic: [{
                            name: '对立式',
                            content: '',
                        }, {
                            name: '双赢式',
                            content: '',
                        }]
                    }
                } else if (jsonStr.docId === 'qdCogiactio2') {
                    this.issuesBothData = [];
                    this.qdData = {
                        both1: '豪利威尔', //己方
                        both2: 'WCHI电视台', //对方
                        title: 'Moms.com的转播权', //项目名称
                        issues: [],
                        background: [],  //背景篇
                        tactic: [{
                            name: '对立式',
                            content: '',
                        }, {
                            name: '双赢式',
                            content: '',
                        }]
                    }
                } else {
                    axios.post("http://www.cogitoactio.com/api/v1/negotiation/getNegotiationById", jsonStr).then(function (res) {
                        var datas = res.data.data[0];
                        console.log(datas);
                        mainVue.qdData = JSON.parse(JSON.stringify(datas));
                        mainVue.issuesBothData = JSON.parse(JSON.stringify(datas.issuesBoth));
                        if (mainVue.issuesBothData[mainVue.issuesBothData.length - 1].name === '') {
                            mainVue.isAdd = true;
                        }
                        if (mainVue.issuesBothData.length >= 3){
                            mainVue.isFull = true;
                        }
                        var isWriteFull = true;
                        for (var i = 0; i < mainVue.issuesBothData.length; i++) {
                            for (var j = 0; j < mainVue.issuesBothData[i].content.length; j++) {
                                if(mainVue.issuesBothData[i].content[j].content==='' || mainVue.issuesBothData[i].content[j].grade===''){
                                    isWriteFull = false;
                                    break;
                                }
                            }
                        }
                        mainVue.isWriteFull = isWriteFull
                    }).catch(function (error) {
                        console.log(error);
                    })
                }
            }
        }
    });
</script>
</body>
</html>