<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>亦知亦行 谈判助手</title>
    <link rel="stylesheet" href="../../assets/node_modules/normalize.css/normalize.css">
    <link rel="stylesheet" href="../../assets/node_modules/animate.css/animate.css">
    <link rel="stylesheet" href="../../assets/css/qdv1.0.main.css">
    <link rel="ICON" href="../../assets/img/main/icon.png">
    <style>
        .positionStatic {
            position: static !important;
            margin-top: 60px !important;
        }

        .weightOverproof span {
            color: #EB5548;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="qd-content" id="qd_issues_page" v-cloak>
    <div class="qd-header-box">
        <div class="qd-page-title-box">
            <a v-bind:href="'../home.html?openid='+userId" class="qd-close-new-btn"></a>
            <h3 class="qd-page-title">议题篇</h3>
            <!--<span>长按文字获取相应解析</span>-->
        </div>
    </div>

    <!-- 2 -->
    <div class="qd-section" id="newIndexSection2">
        <div class="qd-issues-list-header">
            <h3>{{qdData.title}}</h3>
            <p>己方：{{qdData.both2}}</p>
            <p>对方：{{qdData.both1}}</p>
        </div>
        <div class="qd-issues-list-content">
            <div class="qd-module-btn-box clear" v-show="issuesData.length>0">
                <a href="javascript:;" class="qd-module-btn"
                   style="color: white;font-size:16px;background-color: #B5D1E4;border-top: 1px solid #B5D1E4;border-bottom: 1px solid white;border-right: 1px solid white;">议题</a>
                <a href="javascript:;" class="qd-module-btn"
                   style="color: white;font-size:16px;background-color: #B5D1E4;border-top: 1px solid #B5D1E4;border-bottom: 1px solid white;border-right: 1px solid white;">权重</a>
                <a href="javascript:;" class="qd-module-btn"
                   style="color: white;font-size:16px;background-color: #B5D1E4;border-top: 1px solid #B5D1E4;border-bottom: 1px solid white;">操作</a>
            </div>
            <div class="qd-module-btn-box clear" v-for="(data,index) in issuesData">
                <div class="qd-module-btn">
                    <span @click="openModal(2,index)" style="display: block" v-show="isAlter===0||isAlter!==index+1">{{data.name}}</span>
                    <div v-show="isAlter===index+1" class="qd-input-box qd-input-box__1">
                        <input v-model="modalData.name" type="text" class="qd-input" placeholder="议题名称">
                    </div>
                </div>
                <div class="qd-module-btn">
                    <span v-show="isAlter===0||isAlter!==index+1" style="display: block">{{data.weight}}</span>
                    <div v-show="isAlter===index+1" class="qd-input-box qd-input-box__1">
                        <input v-model="modalData.weight" type="text" class="qd-input" placeholder="议题权重">
                    </div>
                </div>
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-1" v-show="isAlter===0||isAlter!==index+1"
                       @click="alterIssues(index)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-2" v-show="isAlter===0||isAlter!==index+1"
                       @click="delIssues(index)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-3" v-show="isAlter===index+1"
                       @click="reAlter(index)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-4" v-show="isAlter===index+1"
                       @click="closeAlter()" href="javascript:;"></a>
                </div>
                <!--<span class="qd-label" v-if="!data.status" v-show="data.content[0].content==='' || data.content[1].content===''">未完成</span>-->
            </div>
            <div class="qd-home-catalog" v-show="issuesData.length<5">
                <div class="qd-add-btn-box" :class="{'qd-add-btn-box-active':isOpenWeb}">
                    <span v-show="!isOpenWeb" class="qd-add-btn" @click="openModal(1)">+</span>
                    <span class="qd-add-btn-title-box" v-show="isOpenWeb">添加</span>
                    <div class="qd-index-box__content qd-index-box_form_content clear" v-show="isOpenWeb">
                        <form action="#" class="qd-index-form qd-index-form__new">
                            <div class="qd-input-box qd-input-box__1">
                                <span>议&ensp;&ensp;&ensp;&ensp;题</span>
                                <input v-model="modalData.name" type="text" class="qd-input" placeholder="请输入议题名称">
                            </div>
                            <div class="qd-input-box qd-input-box__1">
                                <span>权&ensp;&ensp;&ensp;&ensp;重</span>
                                <input v-model="modalData.weight" type="text" class="qd-input" placeholder="请输入此议题权重">
                            </div>
                        </form>
                        <div class="qd-add-btn-box">
                            <div class="qd-btn-box">
                                <a href="javascript:;" @click="addIssues()" class="qd-btn qd-btn__1 qd-btn-box-2">添&nbsp;加</a>
                            </div>
                            <div class="qd-btn-box">
                                <a href="javascript:;" @click="closeAddWeb()"
                                   class="qd-btn qd-btn__3 qd-btn-box-2">取&nbsp;消</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="qd-issues-list-foot" v-bind:class="{'positionStatic':issuesData.length>=3}">
            <div class="qd-btn-box qd-btn-box-2">
                <a v-bind:href="'menu.html?qdId='+qdId"
                   class="qd-btn qd-btn__1 qd-btn__block" style="line-height: 35px">返&nbsp;回</a>
            </div>
            <div class="qd-btn-box qd-btn-box-2">
                <a href="javascript:;"
                   class="qd-btn qd-btn__1 qd-btn__block"
                   style="line-height: 35px;background-color: transparent;color: #333333">
                    总权重:&nbsp;&nbsp;<span>{{allWeight}}</span></a>
            </div>
        </div>
    </div>

    <div class="qd-modal-box" v-show="showModal">
        <div class="qd-modal-header">
            <span @click="showModal = false" class="qd-modal-close-btn"></span>
        </div>
        <div class="qd-modal-content">
            <div class="qd-new-issues-box" v-show="modalNum === 1">
                <div class="qd-new-issues-header">
                    <p>添加议题</p>
                </div>
                <div class="qd-new-issues-content">
                    <div class="qd-input-box">
                        <input v-model="modalData.name" type="text" class="qd-input" placeholder="请输入议题名称">
                    </div>
                </div>
            </div>
            <div class="qd-new-issues-box" v-show="modalNum === 2">
                <div class="qd-new-issues-header">
                    <p>议题：{{modalData.name}}</p>
                </div>
                <div class="qd-new-issues-content">
                    <div class="qd-new-issues-details-box">
                        <p class="qd-new-issues-details" @click="modalNum = 4">渴&nbsp;&nbsp;望（{{modalData.content[0].content | isNull}}）</p>
                        <p class="qd-new-issues-details" @click="modalNum = 5">底&nbsp;&nbsp;线（{{modalData.content[1].content | isNull}}）</p>
                    </div>
                </div>
            </div>
            <!--<div class="qd-new-issues-box" v-show="modalNum === 3">-->
                <!--<div class="qd-new-issues-header">-->
                    <!--<p>权重</p>-->
                    <!--<span>权重，是此议题所占比重（总权重≤100）</span>-->
                <!--</div>-->
                <!--<div class="qd-new-issues-content">-->
                    <!--<div class="qd-input-box qd-input-box__1" v-for="(data,index) in issuesData">-->
                        <!--<span>{{data.name}}：</span>-->
                        <!--<input type="text" oninput="value=value.replace(/[^\d]/g,'')" v-model="issuesData[index].weight"-->
                               <!--@change="changeWeight()" class="qd-input" placeholder="请分配此议题权重">-->
                    <!--</div>-->
                    <!--<p style="text-align: right" v-bind:class="{'weightOverproof': allWeight > 100}">-->
                        <!--总权重：&nbsp;&nbsp;<span>{{allWeight}}</span><span-->
                            <!--v-show="allWeight > 100">（总权重不可超过100）</span></p>-->
                <!--</div>-->
            <!--</div>-->
            <div class="qd-new-issues-box" v-show="modalNum === 4">
                <div class="qd-new-issues-header">
                    <p>渴望</p>
                    <span>渴望，是你在最有利的条件下所能拿到最理想的结果</span>
                </div>
                <div class="qd-new-issues-content">
                    <div class="qd-input-box">
                        <input type="text" v-model="modalData.content[0].content" class="qd-input"
                               placeholder="请输入此议题的渴望">
                    </div>
                    <!--<div class="qd-input-box">-->
                        <!--<input type="text" oninput="value=value.replace(/[^\d]/g,'')"-->
                               <!--v-model="modalData.content[0].grade" class="qd-input" placeholder="请为此选项打分（满分10分）">-->
                    <!--</div>-->
                </div>
            </div>
            <div class="qd-new-issues-box" v-show="modalNum === 5" style="margin-top: 10px">
                <div class="qd-new-issues-header">
                    <p>底线</p>
                    <span>底线，指最差情况下你所能接受的结果</span>
                </div>
                <div class="qd-new-issues-content">
                    <div class="qd-input-box">
                        <input type="text" v-model="modalData.content[1].content" class="qd-input"
                               placeholder="请输入此议题的底线">
                    </div>
                    <!--<div class="qd-input-box">-->
                        <!--<input type="text" oninput="value=value.replace(/[^\d]/g,'')"-->
                               <!--v-model="modalData.content[1].grade" class="qd-input" placeholder="请为此选项打分（满分10分）">-->
                    <!--</div>-->
                </div>
            </div>
        </div>
        <div class="qd-modal-footer">
            <div class="qd-modal-btn-box" v-show="modalNum === 1">
                <div class="qd-btn-box">
                    <a href="javascript:;" @click="addIssues()" class="qd-btn qd-btn__1 qd-btn__block">添&nbsp;加</a>
                </div>
                <div class="qd-btn-box">
                    <a href="javascript:;" @click="showModal = false"
                       class="qd-btn qd-btn__3 qd-btn__block">取&nbsp;消</a>
                </div>
            </div>
            <div class="qd-modal-btn-box" v-show="modalNum === 3 || modalNum === 4 || modalNum === 5 || modalNum === 6">
                <div class="qd-btn-box">
                    <a v-show="modalNum === 4 && modalData.content[0].content === '' || modalNum === 5 && modalData.content[1].content === ''"
                       href="javascript:;" @click="setIssuesContent()"
                       class="qd-btn qd-btn__1 qd-btn__block">确&nbsp;定</a>
                    <a v-show="modalNum === 4 && modalData.content[0].content != '' || modalNum === 5 && modalData.content[1].content != ''"
                       href="javascript:;" @click="setIssuesContent()"
                       class="qd-btn qd-btn__1 qd-btn__block">修&nbsp;改</a>
                    <a v-show="modalNum === 3" href="javascript:;" @click="setWeight()"
                       class="qd-btn qd-btn__1 qd-btn__block">保&nbsp;存</a>
                </div>
                <div class="qd-btn-box">
                    <a href="javascript:;" @click="modalNum = 2" class="qd-btn qd-btn__3 qd-btn__block">返&nbsp;回</a>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="https://cdn.bootcss.com/vue/2.5.17-beta.0/vue.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
<script type="text/javascript">
    'user strict';
    var mainVue = new Vue({
        el: '#qd_issues_page',
        data: {
            issuesPage: 1,
            isCheck: false,
            showModal: false,
            modalNum: 1,
            issuesData: [],
            qdId: '',
            userId: '',
            isAlter: 0,
            beforeData: {
                name: '',
                weight: ''
            },
            modalData: {
                number: 0,
                name: '',
                weight: 0,
                content: [{
                    content: '',
                    grade: '',
                    both1: ''
                }, {
                    content: '',
                    grade: '',
                    both1: '',
                }]
            },
            qdData: [],
            modalSettingParam: {
                settingWeight: false,
                settingLongFor: false,
                settingBaseline: false,
                settingGrade: false
            },
            modalIndex: 0,
            allWeight: 0,
            isOpenWeb: false,

        },
        filters: {
            isNull: function (val) {
                if(val === ''){
                    return '未设置';
                }else{
                    return val;
                }
            }
        },
        methods: {
            openModal: function (val, index) {
                if (val === 1) {
                    this.isOpenWeb = true;
                    this.isAlter = 0
                    this.modalData = {
                        number: 0,
                        name: '',
                        weight: 0,
                        content: [{
                            content: '',
                            grade: '',
                            both1: ''
                        }, {
                            content: '',
                            grade: '',
                            both1: '',
                        }]
                    }
                } else if (val === 2) {
                    this.isOpenWeb = false;
                    console.log(this.issuesData);
                    this.modalSettingParam = {
                        settingWeight: false,
                        settingLongFor: false,
                        settingBaseline: false,
                        settingGrade: false
                    }
                    this.modalNum = 2;
                    this.modalIndex = index
                    this.modalData = JSON.parse(JSON.stringify(this.issuesData[index]))
                    this.showModal = true;
                }
            },

            /*
            * delIssues() 删除议题
            * index: 删除议题的索引
            * */
            delIssues: function (index) {
                var res = confirm("确定删除此议题？");
                if (res) {
                    this.allWeight = this.allWeight - this.issuesData[index].weight
                    this.issuesData.splice(index, 1);
                    this.qdData.issues = this.issuesData;
                    mainVue.updatedIssues(2);
                } else {

                }
            },
            addIssues: function () {
                if (this.modalData.name === '') {
                    alert('请输入议题名称');
                } else if(this.modalData.weight === ''){
                    alert('请输入此议题权重');
                }else {
                    var allWeight = this.allWeight + Number(this.modalData.weight);
                    if(allWeight > 100){
                        this.modalData.weight = 0;
                        alert('总权重大于100，请重新分配！！！');
                    }else {
                        var repetition = false;
                        for (var i in this.issuesData) {
                            if (this.modalData.name === this.issuesData[i].name) {
                                repetition = true;
                                break;
                            }
                        }
                        if (repetition) {
                            alert('议题名称重复');
                        } else {
                            this.allWeight = allWeight
                            this.modalData.number = this.issuesData.length + 1;
                            this.issuesData.push(this.modalData);
                            this.qdData.issues = this.issuesData;
                            mainVue.updatedIssues(1);
                            mainVue.isOpenWeb = false;
                        }
                    }

                }

            },

            alterIssues: function (val) {
                this.isOpenWeb = false;
                this.isAlter = val + 1;
                this.modalData = JSON.parse(JSON.stringify(this.issuesData[val]));
                this.beforeData.name = this.modalData.name;
                this.beforeData.weight = this.modalData.weight;
            },

            reAlter: function (index) {
                if (this.modalData.name === '') {
                    alert('请输入议题名称');
                } else if(this.modalData.weight === ''){
                    alert('请输入此议题权重');
                }else if (this.beforeData.name === this.modalData.name && this.beforeData.weight === this.modalData.weight) {
                    this.isAlter = 0;
                } else {
                    var allWeight = this.allWeight - this.beforeData.weight + Number(this.modalData.weight)
                    if(allWeight > 100){
                        this.modalData.weight = this.beforeData.weight;
                        alert('总权重大于100，请重新分配！！！');
                    }else {
                        this.allWeight = allWeight;
                        this.issuesData[index] = JSON.parse(JSON.stringify(this.modalData));
                        this.qdData.issues = this.issuesData;
                        mainVue.updatedIssues(3);
                    }
                }

            },

            closeAlter: function () {
                this.modalData = {
                    number: 0,
                    name: '',
                    weight: 0,
                    content: [{
                        content: '',
                        grade: '',
                        both1: ''
                    }, {
                        content: '',
                        grade: '',
                        both1: '',
                    }]
                }
                this.isAlter = 0;
            },

            setIssuesContent: function (index) {
                this.issuesData[this.modalIndex] = JSON.parse(JSON.stringify(this.modalData));
                this.qdData.issues = this.issuesData;
                mainVue.updatedIssues(3);
            },

            changeWeight: function () {
                var sum = 0
                for (var i in this.issuesData) {
                    sum = sum + Number(this.issuesData[i].weight);
                }
                this.allWeight = sum
            },

            setWeight: function () {
                if (this.allWeight > 100) {
                    alert('权重总数超过100，请合理分配');
                } else if (this.allWeight <= 100 && this.allWeight > 0) {
                    this.qdData.issues = JSON.parse(JSON.stringify(this.issuesData));
                    mainVue.updatedIssues(4);
                } else {
                    alert('权重分配异常，请重新分配');
                    for (var i in this.issuesData) {
                        this.issuesData[i].weight = 0
                    }
                }
            },

            closeAddWeb: function () {
                mainVue.isOpenWeb = false;
            },

            updatedIssues: function (val) {
                var jsonStr = {
                    userId: '',
                    docId: '',
                    data: '',
                }
                jsonStr.userId = this.userId;
                jsonStr.docId = this.qdId;
                jsonStr.data = this.qdData;
                axios.post("http://www.cogitoactio.com/api/v1/negotiation/updateNegotiation ", jsonStr).then(function (res) {
                    if (res.data.data) {
                        if (val === 1) {
                            mainVue.showModal = false;
                        } else if (val === 2) {
                            alert('删除成功')
                        } else if (val === 3) {
                            mainVue.modalNum = 2;
                            mainVue.isAlter = 0;
                        } else if (val === 4) {
                            mainVue.showModal = false;
                        }
                    } else {
                        alert('请求失败')
                    }

                }).catch(function (error) {
                    console.log(error);
                })
            }
        },
        mounted: function () {
            var userId = localStorage.getItem('userId');
            this.userId = userId;
            if (userId === null) {
                window.location.href = '../home.html'
            }

            function GetRequest() {
                var url = decodeURI(location.search);
                var theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    var str = url.substr(1);
                    strs = str.split("&");
                    for (var i = 0; i < strs.length; i++) {
                        theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                    }
                }
                return theRequest;
            }

            var urlData = GetRequest();
            if (urlData.qdId === undefined) {
                window.location.href = '../home.html'
            } else {
                this.qdId = urlData.qdId;
                var jsonStr = {
                    userId: '',
                    docId: ''
                }
                jsonStr.userId = this.userId;
                jsonStr.docId = this.qdId;
                axios.post("http://www.cogitoactio.com/api/v1/negotiation/getNegotiationById", jsonStr).then(function (res) {
                    console.log(res);
                    mainVue.qdData = res.data.data[0];
                    mainVue.issuesData = res.data.data[0].issues;
                    var allWeight = 0;
                    for (var i in res.data.data[0].issues) {
                        allWeight = allWeight + Number(res.data.data[0].issues[i].weight);
                    }
                    mainVue.allWeight = allWeight;
                }).catch(function (error) {
                    console.log(error);
                })
            }
        }
    });
</script>
</body>
</html>