<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>亦知亦行 知行谈判助手</title>
    <link rel="stylesheet" href="../../assets/node_modules/normalize.css/normalize.css">
    <link rel="stylesheet" href="../../assets/node_modules/animate.css/animate.css">
    <link rel="stylesheet" href="../../assets/css/qdv1.0.main.css">
    <link rel="ICON" href="../../assets/img/main/icon.png">
    <style>
        .positionStatic {
            position: static !important;
            margin-top: 60px !important;
        }

        .weightOverproof span {
            color: #EB5548;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="qd-content" id="qd_issues_page" v-cloak>
    <div class="qd-header-box">
        <div class="qd-page-title-box">
            <a v-bind:href="'menu.html?qdId='+qdId" class="qd-close-new-btn"></a>
            <h3 class="qd-page-title">{{qdData.title}}</h3>
            <!--<span>长按文字获取相应解析</span>-->
        </div>
    </div>

    <!-- 2 -->
    <div class="qd-section" id="newIndexSection2" style="margin-top: 3px">
        <div class="qd-issues-list-content">
            <div class="qd-module-btn-box clear">
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;">查看</a>
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;">议题</a>
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;">权重</a>
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;">优先</a>
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;">操作</a>
            </div>
            <div class="qd-module-btn-box clear" v-for="(data,index) in issuesData">
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-5" @click="openModal(index)"
                       href="javascript:;"></a>
                </div>
                <div class="qd-module-btn">
                    <div class="qd-input-box qd-input-box__1">
                        <input v-model="data.name" @change="reAlter(index)" type="text" class="qd-input"
                               placeholder="议题名称">
                    </div>
                </div>
                <div class="qd-module-btn">
                    <div class="qd-input-box qd-input-box__1">
                        <input v-model="data.weight" @change="reAlter(index)" type="text" class="qd-input"
                               placeholder="议题权重">
                    </div>
                </div>
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-3" v-show="!isAdd&&index!==0&&data.name!==''"
                       @click="btnPriority(1,index)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-3"
                       v-show="isAdd&&data.number!==1&&data.name!==''&&index !== issuesData.length-1"
                       @click="btnPriority(1)" href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-4"
                       v-show="!isAdd&&index !== issuesData.length-1&&data.name!==''" @click="btnPriority(2,index)"
                       href="javascript:;"></a>
                    <a class="qd-module-small-btn qd-module-small-btn-4"
                       v-show="isAdd&&index !== issuesData.length-2&&index !== issuesData.length-1&&data.name!==''"
                       @click="btnPriority(2)" href="javascript:;"></a>
                </div>
                <div class="qd-module-btn">
                    <a class="qd-module-small-btn qd-module-small-btn-2" @click="delIssues(index)"
                       href="javascript:;"></a>
                </div>
            </div>

            <div class="qd-module-btn-box qd-module-add-btn-box clear">
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;"></a>
                <a href="javascript:;" class="qd-module-btn" v-show="isAdd" style="font-size:16px;width: 40%"></a>
                <a href="javascript:;" class="qd-module-btn" v-show="!isAdd" @click="openModal(1)"
                   style="font-size:16px;width: 40%">+</a>
                <a href="javascript:;" class="qd-module-btn"
                   style="font-size:16px;width: 40%">总权重：&nbsp;{{allWeight}}</a>
                <a href="javascript:;" class="qd-module-btn" style="font-size:16px;"></a>
            </div>
        </div>
    </div>

    <div class="qd-modal-box" v-show="showModal">
        <div class="qd-modal-header">
            <span @click="showModal = false" class="qd-modal-close-btn"></span>
        </div>
        <div class="qd-modal-content">
            <div class="qd-new-issues-box">
                <div class="qd-new-issues-header">
                    <p>议题：{{modalData.name}}</p>
                </div>
                <div class="qd-new-issues-content">
                    <div class="qd-new-issues-details-box">
                        <p class="qd-new-issues-details">此议题在对您都有利的条件下，您所能拿到最理想的结果是
                            <input type="text" v-model="modalData.content[0].content" @change="changeIssuesContent()"
                                   class="qd-new-issues-details-input"/>
                            <span class="qd-new-issues-details-grade">,&nbsp;&nbsp;此选项的评分是
                                <input type="text" v-model="modalData.content[0].grade" disabled
                                       class="qd-new-issues-details-input"/>。
                            </span>
                        </p>
                        <p class="qd-new-issues-details">此议题在对您最坏的条件下，您所能拿到的可承受结果是
                            <input type="text" v-model="modalData.content[1].content" @change="changeIssuesContent()"
                                   class="qd-new-issues-details-input">
                            <span class="qd-new-issues-details-grade">,&nbsp;&nbsp;此选项的评分是
                                <input type="text" v-model="modalData.content[1].grade" @change="changeIssuesContent()"
                                       class="qd-new-issues-details-input"/>。
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="https://cdn.bootcss.com/vue/2.5.17-beta.0/vue.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
<script type="text/javascript">
    'user strict';
    var mainVue = new Vue({
        el: '#qd_issues_page',
        data: {
            issuesPage: 1,
            isCheck: false,
            showModal: false,
            modalNum: 1,
            issuesData: [],
            qdId: '',
            userId: '',
            isAlter: 0,
            beforeData: {
                name: '',
                weight: ''
            },
            modalData: {
                number: 0,
                name: '',
                weight: 0,
                content: [{
                    content: '',
                    grade: '10',
                    both1: ''
                }, {
                    content: '',
                    grade: '',
                    both1: '',
                }]
            },
            qdData: [],
            modalSettingParam: {
                settingWeight: false,
                settingLongFor: false,
                settingBaseline: false,
                settingGrade: false
            },
            modalIndex: 0,
            isOpenWeb: false,
            isAdd: false,

        },
        computed: {
            allWeight: function () {
                var allWeight = 0
                for (var i in this.issuesData) {
                    allWeight = allWeight + Number(this.issuesData[i].weight)
                }
                return allWeight;
            },
        },
        filters: {
            isNull: function (val) {
                if (val === '') {
                    return '未设置';
                } else {
                    return val;
                }
            },
        },
        methods: {
            openModal: function (index) {
                this.isOpenWeb = false;
                console.log(this.issuesData);
                this.modalSettingParam = {
                    settingWeight: false,
                    settingLongFor: false,
                    settingBaseline: false,
                    settingGrade: false
                }
                this.modalIndex = index;
                console.log(this.modalIndex)
                this.modalData = JSON.parse(JSON.stringify(this.issuesData[index]))
                this.showModal = true;

            },

            /*
            * delIssues() 删除议题
            * index: 删除议题的索引
            * */
            delIssues: function (index) {
                var res = confirm("确定删除此议题？");
                if (res) {
                    this.issuesData.splice(index, 1);
                    this.qdData.issues = JSON.parse(JSON.stringify(this.issuesData));
                    mainVue.updatedIssues(2);
                } else {

                }
            },

            btnPriority: function (val, index) {
                if (val === 1) {
                    console.log(index);
                    this.issuesData[index] = JSON.parse(JSON.stringify(this.qdData.issues[index - 1]))
                    this.issuesData[index].number = index;
                    this.issuesData[index - 1] = JSON.parse(JSON.stringify(this.qdData.issues[index]));
                    this.issuesData[index - 1].number = index - 1;
                    console.log(this.issuesData[index]);
                    this.qdData.issues = JSON.parse(JSON.stringify(this.issuesData));
                    mainVue.updatedIssues(5);
                } else if (val === 2) {
                    console.log(index);
                    this.issuesData[index] = JSON.parse(JSON.stringify(this.qdData.issues[index + 1]))
                    this.issuesData[index].number = index;
                    this.issuesData[index + 1] = JSON.parse(JSON.stringify(this.qdData.issues[index]));
                    this.issuesData[index + 1].number = index + 1;
                    console.log(this.issuesData[index]);
                    this.qdData.issues = JSON.parse(JSON.stringify(this.issuesData));
                    mainVue.updatedIssues(5);
                }

            },

            addIssues: function () {
                if (this.modalData.name === '') {
                    alert('请输入议题名称');
                } else if (this.modalData.weight === '') {
                    alert('请输入此议题权重');
                } else {
                    var allWeight = this.allWeight + Number(this.modalData.weight);
                    if (allWeight > 100) {
                        this.modalData.weight = 0;
                        alert('总权重大于100，请重新分配！！！');
                    } else {
                        var repetition = false;
                        for (var i in this.issuesData) {
                            if (this.modalData.name === this.issuesData[i].name) {
                                repetition = true;
                                break;
                            }
                        }
                        if (repetition) {
                            alert('议题名称重复');
                        } else {
                            this.allWeight = allWeight
                            this.modalData.number = this.issuesData.length + 1;
                            this.issuesData.push(this.modalData);
                            this.qdData.issues = this.issuesData;
                            mainVue.updatedIssues(1);
                            mainVue.isOpenWeb = false;
                        }
                    }

                }

            },

            reAlter: function (index) {
                console.log(this.issuesData);
                if (this.issuesData[index].name === '') {
                    alert('请输入议题名称');
                } else if (this.issuesData[index].weight === '') {
                    alert('请输入此议题权重');
                    this.issuesData[index].weight = 0
                } else {
                    if (this.allWeight > 100) {
                        alert('总权重大于100，请重新分配！！！');
                        this.issuesData[index].weight = 0
                    } else {
                        var repetition = false;
                        for (var i in this.issuesData) {
                            if (index == i) {

                            } else {
                                if (this.issuesData[index].name === this.issuesData[i].name) {
                                    repetition = true;
                                    break;
                                }
                            }
                        }
                        console.log(repetition)
                        if (repetition) {
                            alert('议题名称重复');
                            if (this.isAdd) {
                                this.issuesData[index].name = ''
                            } else {
                                this.issuesData[index].name = String(this.qdData.issues[index].name);
                            }
                        } else {
                            this.qdData.issues = JSON.parse(JSON.stringify(this.issuesData));
                            mainVue.updatedIssues(3);
                        }
                    }
                }

            },

            closeAlter: function () {
                this.modalData = {
                    number: 0,
                    name: '',
                    weight: 0,
                    content: [{
                        content: '',
                        grade: '',
                        both1: ''
                    }, {
                        content: '',
                        grade: '',
                        both1: '',
                    }]
                }
                this.isAlter = 0;
            },

            changeIssuesContent: function (index) {
                this.qdData.issues[mainVue.modalIndex].content = JSON.parse(JSON.stringify(this.modalData.content));
            },

            changeWeight: function () {
                var sum = 0
                for (var i in this.issuesData) {
                    sum = sum + Number(this.issuesData[i].weight);
                }
                this.allWeight = sum
            },

            setWeight: function () {
                if (this.allWeight > 100) {
                    alert('权重总数超过100，请合理分配');
                } else if (this.allWeight <= 100 && this.allWeight > 0) {
                    this.qdData.issues = JSON.parse(JSON.stringify(this.issuesData));
                    mainVue.updatedIssues(4);
                } else {
                    alert('权重分配异常，请重新分配');
                    for (var i in this.issuesData) {
                        this.issuesData[i].weight = 0
                    }
                }
            },

            closeAddWeb: function () {
                mainVue.isOpenWeb = false;
            },

            updatedIssues: function (val) {
                var jsonStr = {
                    userId: '',
                    docId: '',
                    data: '',
                }
                jsonStr.userId = this.userId;
                jsonStr.docId = this.qdId;
                jsonStr.data = this.qdData;
                axios.post("http://www.cogitoactio.com/api/v1/negotiation/updateNegotiation ", jsonStr).then(function (res) {
                    if (res.data.data) {
                        if (val === 1) {
                            mainVue.showModal = false;
                        } else if (val === 2) {
                            alert('删除成功')
                        } else if (val === 3) {
                            mainVue.modalNum = 2;
                            mainVue.isAlter = 0;
                        } else if (val === 4) {
                            mainVue.showModal = false;
                        }
                        if (mainVue.issuesData[mainVue.issuesData.length - 1].name === '') {
                            mainVue.isAdd = true;
                        } else {
                            mainVue.isAdd = false;
                        }

                        mainVue.issuesData = JSON.parse(JSON.stringify(mainVue.qdData.issues));
                    } else {
                        alert('请求失败')
                    }

                }).catch(function (error) {
                    console.log(error);
                })
            }
        },
        mounted: function () {
            var userId = localStorage.getItem('userId');
            this.userId = userId;
            if (userId === null) {
                window.location.href = '../home.html'
            }

            function GetRequest() {
                var url = decodeURI(location.search);
                var theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    var str = url.substr(1);
                    strs = str.split("&");
                    for (var i = 0; i < strs.length; i++) {
                        theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                    }
                }
                return theRequest;
            }

            var urlData = GetRequest();
            if (urlData.qdId === undefined) {
                window.location.href = '../home.html'
            } else {
                this.qdId = urlData.qdId;
                var jsonStr = {
                    userId: '',
                    docId: ''
                }
                jsonStr.userId = this.userId;
                jsonStr.docId = this.qdId;
                axios.post("http://www.cogitoactio.com/api/v1/negotiation/getNegotiationById", jsonStr).then(function (res) {
                    console.log(res);
                    mainVue.qdData = JSON.parse(JSON.stringify(res.data.data[0]));
                    mainVue.issuesData = JSON.parse(JSON.stringify(res.data.data[0].issues));
                    if (mainVue.issuesData[mainVue.issuesData.length - 1].name === '') {
                        mainVue.isAdd = true;
                    }
                }).catch(function (error) {
                    console.log(error);
                })
            }
        }
    });
</script>
</body>
</html>